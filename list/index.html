<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Flock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { background: #0f172a; color: white; font-family: 'Poppins', sans-serif; padding: 20px; }
    h2 { text-align: center; margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
    .card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
    .card:hover { background: rgba(255,255,255,0.1); }
    .status { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #333; margin-top: 5px; display: inline-block; }
    .add-btn { position: fixed; bottom: 20px; right: 20px; background: #4facfe; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
  </style>
</head>
<body>

<h2 id="headerTitle">Loading Flock...</h2>
<div id="grid" class="grid"></div>
<a href="../dashboard/add-member.html" class="add-btn">+</a>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { initializeFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
    authDomain: "fob-database-139d1.firebaseapp.com",
    projectId: "fob-database-139d1",
    storageBucket: "fob-database-139d1.firebasestorage.app",
    messagingSenderId: "375165731354",
    appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = initializeFirestore(app, { experimentalForceLongPolling: true }, "fobrealdbase");

 async function loadGroupedFlock(user) {
    const grid = document.getElementById('grid');
    grid.innerHTML = "Organizing your branch...";

    try {
        // 1. Get the Pastor's data
        const pastorSnap = await getDoc(doc(db, "pastors", user.uid));
        if (!pastorSnap.exists()) {
            grid.innerHTML = "Access Denied or Not a Pastor.";
            return;
        }

        // 2. Fetch all Shepherds assigned to this Pastor
        const shepherdsQ = query(collection(db, "shepherds"), where("assigned_pastor_id", "==", user.uid));
        const shepherdSnaps = await getDocs(shepherdsQ);
        
        // Store shepherds in a map for easy access
        let shepherdMap = {}; 
        shepherdSnaps.forEach(s => {
            shepherdMap[s.id] = { name: s.data().full_name, members: [] };
        });

        // 3. Fetch all Members assigned to this Pastor
        const membersQ = query(collection(db, "members"), where("pastorId", "==", user.uid));
        const memberSnaps = await getDocs(membersQ);

        let directMembers = [];

        // 4. Sort Members into their Shepherd's "buckets"
        memberSnaps.forEach(m => {
            const data = m.data();
            const mId = m.id;
            const shepherdId = data.shepherdId;

            if (shepherdId && shepherdMap[shepherdId]) {
                shepherdMap[shepherdId].members.push({ id: mId, ...data });
            } else {
                directMembers.push({ id: mId, ...data });
            }
        });

        // 5. RENDER THE HTML
        grid.innerHTML = ""; // Clear loader

        // --- SECTION: Direct Members ---
        if (directMembers.length > 0) {
            renderHeader(grid, "Directly Under You");
            directMembers.forEach(m => renderMemberCard(grid, m));
        }

        // --- SECTION: Shepherd Groups ---
        for (const sId in shepherdMap) {
            const shepherd = shepherdMap[sId];
            renderHeader(grid, `Shepherd: ${shepherd.name}`); // THE SHEPHERD'S NAME APPEARS FIRST
            
            if (shepherd.members.length === 0) {
                grid.innerHTML += `<p style="padding-left:20px; color:#666; font-size:0.8rem;">No members yet.</p>`;
            } else {
                shepherd.members.forEach(m => renderMemberCard(grid, m));
            }
        }

    } catch (e) {
        console.error(e);
        grid.innerHTML = "Error loading list.";
    }
}

// Helper: Create a Section Header
function renderHeader(container, text) {
    const h = document.createElement('h3');
    h.style = "grid-column: 1/-1; margin-top: 30px; border-left: 4px solid #4facfe; padding-left: 15px; color: #4facfe; font-size: 1rem; background: rgba(79, 172, 254, 0.05); padding-top: 10px; padding-bottom: 10px;";
    h.textContent = text;
    container.appendChild(h);
}

// Helper: Create a Member Card
function renderMemberCard(container, member) {
    const card = document.createElement('div');
    card.className = 'card';
    card.onclick = () => window.location.href = `profile.html?id=${member.id}`;
    card.innerHTML = `
        <div>
          <h3>${member.full_name}</h3>
          <span class="status">${member.status}</span>
        </div>
        <div style="font-size:1.5rem">â€º</div>`;
    container.appendChild(card);
}
  }

  onAuthStateChanged(auth, (user) => {
    if (user) loadFlock(user);
    else window.location.href = "../index.html";
  });
</script>
</body>
</html>
