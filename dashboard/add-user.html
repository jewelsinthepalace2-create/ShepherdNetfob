<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Staff Hierarchy | ShepherdNet</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/60bRQP5Z/Jewels-background-removed.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <style>
    :root { 
        --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
        --border: rgba(255, 255, 255, 0.1); --text-dim: #888;
        --success: #00ff88; --error: #ff4b5c; --gold: #ffd700;
    }
    
    body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; padding: 20px; margin: 0; display: flex; justify-content: center; }
    .container { width: 100%; max-width: 900px; padding-bottom: 100px; }
    
    .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
    
    /* --- HIERARCHY LIST --- */
    .hierarchy-card { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 30px; backdrop-filter: blur(10px); }
    
    .node-group { margin-bottom: 10px; padding-left: 25px; border-left: 1px dashed rgba(255,255,255,0.1); }
    .node-group.top-level { padding-left: 0; border-left: none; }

    .row { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 12px 18px; border-radius: 12px; border: 1px solid var(--border);
        transition: 0.2s; background: rgba(255,255,255,0.02); margin-top: 8px;
    }
    
    .row-master { border-left: 6px solid var(--gold); background: rgba(255, 215, 0, 0.05); margin-bottom: 15px; }
    .row-pastor { border-left: 4px solid var(--primary); }
    .row-shepherd { border-left: 4px solid var(--success); font-size: 0.9rem; }

    .badge { font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; margin-right: 10px; }
    .badge-master { background: var(--gold); color: #000; }
    .badge-pastor { background: var(--primary); color: #0f172a; }
    .badge-shepherd { background: var(--success); color: #0f172a; }

    /* --- FORM MODAL --- */
    #formOverlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); 
        display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content { background: #1e293b; padding: 35px; border-radius: 24px; width: 95%; max-width: 550px; border: 1px solid var(--border); position: relative; }
    .close-modal { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; cursor: pointer; color: var(--text-dim); }

    .btn-add { background: var(--primary); color: #0f172a; padding: 12px 24px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; }
    .delete-btn { color: var(--error); background: none; border: none; cursor: pointer; font-size: 0.7rem; opacity: 0.4; }
    .delete-btn:hover { opacity: 1; text-decoration: underline; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .full { grid-column: span 2; }
    input, select { width: 100%; padding: 11px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; color: white; font-family: inherit; outline: none; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="container">
    <div class="header-flex">
        <div>
            <h1 style="margin:0; font-size: 1.5rem;">Network <span style="color: var(--primary);">Management</span></h1>
            <p style="opacity: 0.5; font-size: 0.8rem;">Multi-level Pastoral Hierarchy</p>
        </div>
        <button class="btn-add" onclick="toggleForm(true)">+ Register Staff</button>
    </div>

    <div class="hierarchy-card" id="hierarchyTree">
        <p style="text-align:center; opacity:0.3; padding: 40px;">Building network tree...</p>
    </div>
</div>

<div id="formOverlay">
    <div class="modal-content">
        <span class="close-modal" onclick="toggleForm(false)">&times;</span>
        <h2 style="margin-top:0; color: var(--primary);">Deploy Personnel</h2>
        <form id="signupForm">
            <div class="form-grid">
                <div class="full">
                    <label style="font-size:0.6rem; color:var(--text-dim);">SYSTEM TIER</label>
                    <select id="role" required>
                        <option value="shepherds">Shepherd</option>
                        <option value="pastors">Pastor</option>
                        
                    </select>
                </div>
                <div class="full"><input type="text" id="fullName" placeholder="Full Name" required></div>
                <div class="full hidden" id="chapelField"><input type="text" id="chapelName" placeholder="Chapel Name"></div>
                <div><select id="gender"><option value="Male">Male</option><option value="Female">Female</option></select></div>
                <div><input type="date" id="dob"></div>
                <div class="full"><input type="tel" id="contact" placeholder="Contact Number" required></div>
                <div class="full"><input type="email" id="email" placeholder="Email Address" required></div>
                <div class="full"><input type="password" id="password" placeholder="Initial Password" required minlength="6"></div>
            </div>
            <button type="submit" class="btn-add" style="width:100%; margin-top:20px;" id="submitBtn">Confirm Registration</button>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, getDocs, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    (function() { emailjs.init("hbLNGNgE4WvbIYFFr"); })();

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc", 
        authDomain: "fob-database-139d1.firebaseapp.com", 
        projectId: "fob-database-139d1", 
        storageBucket: "fob-database-139d1.firebasestorage.app", 
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3" 
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app, "fobrealdbase");
    const auth = getAuth(app);

    let loggedInUserUID = "";

    onAuthStateChanged(auth, user => {
        if (user) { loggedInUserUID = user.uid; loadHierarchy(); }
        else { window.location.href = "/index.html"; }
    });

    window.toggleForm = (show) => { document.getElementById('formOverlay').style.display = show ? 'flex' : 'none'; };
    document.getElementById('role').onchange = (e) => {
        document.getElementById('chapelField').classList.toggle('hidden', e.target.value !== 'pastors');
    };

    async function loadHierarchy() {
        const container = document.getElementById('hierarchyTree');
        const [mSnap, pSnap, sSnap] = await Promise.all([
            getDocs(collection(db, "master_admin")),
            getDocs(collection(db, "pastors")),
            getDocs(collection(db, "shepherds"))
        ]);

        const masters = mSnap.docs.map(d => ({id: d.id, ...d.data()}));
        const pastors = pSnap.docs.map(d => ({id: d.id, ...d.data()}));
        const shepherds = sSnap.docs.map(d => ({id: d.id, ...d.data()}));

        let treeHtml = "";

        // 1. Render Masters
        masters.forEach(m => {
            treeHtml += `<div class="row row-master"><div><span class="badge badge-master">Master Admin</span><b>${m.full_name}</b></div><button class="delete-btn" onclick="deleteUser('master_admin', '${m.id}')">Delete</button></div>`;
        });

        // 2. Recursive function to find children (Pastors or Shepherds)
        function buildNode(parentId, levelClass = "top-level") {
            let html = `<div class="node-group ${levelClass}">`;
            
            // Find Pastors under this parent
            const subPastors = pastors.filter(p => p.pastorId === parentId);
            subPastors.forEach(p => {
                html += `
                    <div class="row row-pastor">
                        <div><span class="badge badge-pastor">Pastor</span><b>${p.full_name}</b> <small style="opacity:0.4;">${p.chapel_name || ''}</small></div>
                        <button class="delete-btn" onclick="deleteUser('pastors', '${p.id}')">Delete</button>
                    </div>`;
                html += buildNode(p.id, ""); // Recursive call for this pastor's children
            });

            // Find Shepherds under this parent
            const subShepherds = shepherds.filter(s => s.pastorId === parentId);
            subShepherds.forEach(s => {
                html += `
                    <div class="row row-shepherd">
                        <div><span class="badge badge-shepherd">Shepherd</span>${s.full_name}</div>
                        <button class="delete-btn" onclick="deleteUser('shepherds', '${s.id}')">Delete</button>
                    </div>`;
            });

            html += `</div>`;
            return (subPastors.length > 0 || subShepherds.length > 0) ? html : "";
        }

        // 3. Start tree from "Top Level" Pastors (those not assigned to another pastor)
        // Or those assigned to a Master Admin
        const masterUIDs = masters.map(m => m.id);
        const topPastors = pastors.filter(p => !p.pastorId || masterUIDs.includes(p.pastorId));

        topPastors.forEach(tp => {
            treeHtml += `
                <div class="row row-pastor" style="margin-left:0; border-left-width:6px;">
                    <div><span class="badge badge-pastor">Senior Pastor</span><b>${tp.full_name}</b></div>
                    <button class="delete-btn" onclick="deleteUser('pastors', '${tp.id}')">Delete</button>
                </div>`;
            treeHtml += buildNode(tp.id, "");
        });

        container.innerHTML = treeHtml || "<p style='text-align:center; opacity:0.3; padding: 40px;'>No Staff Found.</p>";
    }

    window.deleteUser = async (coll, id) => {
        if (confirm("Delete this staff record?")) {
            await deleteDoc(doc(db, coll, id));
            loadHierarchy();
        }
    };

    document.getElementById('signupForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerText = "Processing...";
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const collectionName = document.getElementById('role').value;
        const roleLabel = collectionName.split('_')[0].slice(0, -1);

        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        try {
            const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
            await setDoc(doc(db, collectionName, cred.user.uid), {
                full_name: document.getElementById('fullName').value,
                role: roleLabel, email: email, contact: document.getElementById('contact').value,
                pastorId: loggedInUserUID, created_at: serverTimestamp(),
                chapel_name: document.getElementById('chapelName').value || "N/A"
            });
            await emailjs.send("service_vzxws9f", "template_buctifq", {
                full_name: document.getElementById('fullName').value,
                role: roleLabel, email: email, password: password
            });
            await signOut(secondaryAuth);
            await deleteApp(secondaryApp);
            toggleForm(false); loadHierarchy(); document.getElementById('signupForm').reset();
        } catch (e) { alert(e.message); }
        finally { btn.disabled = false; btn.innerText = "Confirm Registration"; }
    };
</script>
</body>
</html>
