<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registry | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --text-dim: rgba(255, 255, 255, 0.5);
            --green: #00ff88;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; min-height: 100vh; padding: 20px; }

        .container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        
        header { margin-bottom: 30px; text-align: left; }
        h1 { font-size: 1.5rem; font-weight: 600; }
        #roleInfo { font-size: 0.8rem; color: var(--primary); opacity: 0.8; }

        /* Member Card as a Link */
        .member-link { text-decoration: none; color: inherit; display: block; margin-bottom: 15px; }

        .member-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .member-link:hover .member-card { border-color: var(--primary); transform: translateY(-3px); background: rgba(255,255,255,0.08); }

        .name-box { font-weight: 600; font-size: 1.05rem; display: flex; align-items: center; gap: 8px; }
        .sub-text { font-size: 0.75rem; color: var(--text-dim); margin-top: 4px; }
        
        .streak-container { display: flex; gap: 8px; margin-top: 12px; }
        .dot {
            width: 14px; height: 14px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            cursor: pointer; transition: 0.3s;
            position: relative; z-index: 10; /* Ensures dot stays above the card link */
        }
        .dot.present { 
            background: var(--green); 
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.4); 
            border: none; 
        }

        .fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; background: var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #0f172a; font-size: 24px; text-decoration: none; font-weight: bold;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
            z-index: 100;
        }

        .loading-spinner { text-align: center; padding: 50px; color: var(--text-dim); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="headerTitle">Registry</h1>
        <p id="roleInfo">Authenticating...</p>
    </header>

    <div id="memberList">
        <div class="loading-spinner">Fetching souls...</div>
    </div>
</div>

<a href="../dashboard/add-member.html" class="fab">+</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, getDoc, doc, orderBy, limit, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "fobrealdbase");

    let latestEvents = [];
    const nameCache = {};

    async function fetchLatestEvents() {
        try {
            const q = query(collection(db, "events"), orderBy("date", "desc"), limit(5));
            const snap = await getDocs(q);
            latestEvents = snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
        } catch (e) { console.error("Events error:", e); }
    }

    async function getAddedByName(pastorId, shepherdId) {
        let targetId = (shepherdId && shepherdId !== "direct_pastor_entry" && shepherdId !== "master_admin_entry") 
                       ? shepherdId : pastorId;
        
        if (!targetId) return "Registry";
        if (nameCache[targetId]) return nameCache[targetId];

        const collections = ["master_admin", "pastors", "shepherds"];
        for (const coll of collections) {
            const userSnap = await getDoc(doc(db, coll, targetId));
            if (userSnap.exists()) {
                const label = coll === "shepherds" ? "Shep." : coll === "pastors" ? "Past." : "Admin";
                nameCache[targetId] = `${label}: ${userSnap.data().full_name}`;
                return nameCache[targetId];
            }
        }
        return "Unknown User";
    }

    // Toggle Attendance with Propagation Stop
    window.toggleAttendance = async (event, dot, memberId, eventId) => {
        event.preventDefault(); 
        event.stopPropagation(); // Stops the card link from opening

        const attId = `${memberId}_${eventId}`;
        const attRef = doc(db, "attendance", attId);

        try {
            if (dot.classList.contains('present')) {
                await deleteDoc(attRef);
                dot.classList.remove('present');
            } else {
                await setDoc(attRef, { 
                    status: 'present', 
                    timestamp: new Date(),
                    memberId: memberId,
                    eventId: eventId
                });
                dot.classList.add('present');
            }
        } catch (e) {
            console.error("Attendance Error:", e);
            alert("Permission denied or connection error.");
        }
    };

    async function loadRegistry(userQuery) {
        const listDiv = document.getElementById('memberList');
        const snaps = await getDocs(userQuery);
        listDiv.innerHTML = "";

        if (snaps.empty) {
            listDiv.innerHTML = "<p style='text-align:center; opacity:0.5; margin-top:50px;'>No members found in your flock.</p>";
            return;
        }

        for (const mDoc of snaps.docs) {
            const m = mDoc.data();
            const addedBy = await getAddedByName(m.pastorId, m.shepherdId);
            
            // Generate Attendance Dots
            let dotsHtml = `<div class="streak-container">`;
            for (const ev of latestEvents) {
                const attSnap = await getDoc(doc(db, "attendance", `${mDoc.id}_${ev.id}`));
                dotsHtml += `<div class="dot ${attSnap.exists() ? 'present' : ''}" 
                                  title="${ev.name} (${ev.date})" 
                                  onclick="toggleAttendance(event, this, '${mDoc.id}', '${ev.id}')"></div>`;
            }
            dotsHtml += `</div>`;

            listDiv.innerHTML += `
                <a href="profile.html?id=${mDoc.id}" class="member-link">
                    <div class="member-card">
                        <div>
                            <div class="name-box">${m.first_name} ${m.last_name}</div>
                            <div class="sub-text">${addedBy}</div>
                            ${dotsHtml}
                        </div>
                        <div style="opacity:0.2; font-size:1.5rem">â€º</div>
                    </div>
                </a>`;
        }
    }

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "../index.html"; return; }
        
        await fetchLatestEvents();

        const adminSnap = await getDoc(doc(db, "master_admin", user.uid));
        const pastorSnap = await getDoc(doc(db, "pastors", user.uid));
        const shepherdSnap = await getDoc(doc(db, "shepherds", user.uid));

        if (adminSnap.exists()) {
            document.getElementById('roleInfo').innerText = "Logged in as Master Admin";
            loadRegistry(query(collection(db, "members"), orderBy("last_name")));
        } else if (pastorSnap.exists()) {
            document.getElementById('roleInfo').innerText = `Pastor: ${pastorSnap.data().full_name}`;
            loadRegistry(query(collection(db, "members"), where("pastorId", "==", user.uid)));
        } else if (shepherdSnap.exists()) {
            document.getElementById('roleInfo').innerText = `Shepherd: ${shepherdSnap.data().full_name}`;
            loadRegistry(query(collection(db, "members"), where("shepherdId", "==", user.uid)));
        }
    });
</script>
</body>
</html>
