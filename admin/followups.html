<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <title>Global Intelligence | ShepherdNet</title>    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">    <style>
        :root { --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1); --red: #ff4b5c; --green: #00ff88; --gold: #ffd700; }
        body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }
        header { margin-bottom: 30px; }
        .back-link { color: var(--primary); text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; display: inline-block; }
        
        /* --- FILTERS & KEYS --- */
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        select { background: #1e293b; color: white; border: 1px solid var(--border); padding: 10px; border-radius: 10px; width: 100%; outline: none; cursor: pointer; }
        
        .intelligence-key { background: rgba(79, 172, 254, 0.05); border: 1px solid var(--primary); padding: 20px; border-radius: 20px; margin-bottom: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 0.8rem; }
        .key-item b { color: var(--primary); display: block; margin-bottom: 5px; text-transform: uppercase; }

        /* --- ANALYTICS --- */
        .analytics-card { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 25px; margin-bottom: 30px; }
        .graph-container { display: flex; align-items: flex-end; gap: 10px; height: 150px; margin-top: 20px; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .bar { width: 100%; border-radius: 8px 8px 0 0; transition: height 0.5s ease; position: relative; }
        .bar-present { background: var(--primary); }
        .bar-absent { background: rgba(255,255,255,0.1); }
        .bar-label { font-size: 0.65rem; opacity: 0.6; margin-top: 5px; }

        /* --- TABLES --- */
        .missing-list { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        th { text-align: left; opacity: 0.5; padding: 10px; font-weight: 400; border-bottom: 1px solid var(--border); }
        td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .badge-missing { color: var(--red); background: rgba(255,75,92,0.1); padding: 2px 8px; border-radius: 5px; font-size: 0.7rem; }

        .feed-card { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 15px; position: relative; border-left: 4px solid var(--primary); }
        .note-text { font-style: italic; color: #cbd5e1; font-size: 0.9rem; margin: 10px 0; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; }
        .loading-spinner { text-align: center; padding: 50px; }
    </style></head><body>

<div class="container">
    <header>
        <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
        <h1>Global Intelligence</h1>
        <p style="opacity: 0.6;">Retention & Attendance Analytics</p>
    </header>

    <div class="intelligence-key">
        <div class="key-item">
            <b>The Retention Metric</b>
            Implication: Shows the conversion rate of Saturday Invitees to Sunday Members. If Invitees are missing, follow-up intensity must increase within 24 hours.
        </div>
        <div class="key-item">
            <b>Expected vs Present</b>
            Implication: Identifying the gap helps Pastors see "Leakage." People in the "Missing" list are at high risk of falling out of the network.
        </div>
    </div>

    <div class="filter-grid">
        <div>
            <label style="font-size: 0.7rem; opacity: 0.6;">CHAPEL / PASTOR</label>
            <select id="pastorFilter"><option value="all">All Chapels</option></select>
        </div>
        <div>
            <label style="font-size: 0.7rem; opacity: 0.6;">TIME RANGE</label>
            <select id="timeFilter">
                <option value="7">Last 7 Days (Weekly)</option>
                <option value="30">Last 30 Days (Monthly)</option>
            </select>
        </div>
        <div>
            <label style="font-size: 0.7rem; opacity: 0.6;">CATEGORY</label>
            <select id="typeFilter">
                <option value="all">All People</option>
                <option value="member">Members</option>
                <option value="invitee">Invitees</option>
            </select>
        </div>
    </div>

    <div class="analytics-card">
        <h3 style="font-size: 0.9rem;">Attendance Visualization</h3>
        <div class="graph-container" id="graphArea"></div>
    </div>

    <div class="missing-list">
        <h3 style="font-size: 0.9rem; color: var(--red);">Expected but Not Present</h3>
        <table>
            <thead>
                <tr>
                    <th>NAME</th>
                    <th>CATEGORY</th>
                    <th>INVITED BY / SHEPHERD</th>
                    <th>STATUS</th>
                </tr>
            </thead>
            <tbody id="missingTableBody">
                </tbody>
        </table>
    </div>

    <div id="intelligenceFeed">
        <div class="loading-spinner">Analyzing Database...</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app, "fobrealdbase");
    const auth = getAuth(app);

    const pastorFilter = document.getElementById('pastorFilter');
    const timeFilter = document.getElementById('timeFilter');
    const typeFilter = document.getElementById('typeFilter');
    const missingTable = document.getElementById('missingTableBody');
    const feed = document.getElementById('intelligenceFeed');

    onAuthStateChanged(auth, user => { if(user) init(); });

    async function init() {
        const snap = await getDocs(collection(db, "pastors"));
        snap.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = d.data().full_name;
            pastorFilter.appendChild(opt);
        });
        updateView();
    }

    async function updateView() {
        const days = parseInt(timeFilter.value);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);

        const [attSnap, memSnap, invSnap] = await Promise.all([
            getDocs(query(collection(db, "attendance"), where("timestamp", ">=", cutoff))),
            getDocs(collection(db, "members")),
            getDocs(collection(db, "invitees"))
        ]);

        processIntelligence(attSnap, memSnap, invSnap);
    }

    function processIntelligence(attSnap, memSnap, invSnap) {
        const pFilter = pastorFilter.value;
        const cFilter = typeFilter.value;

        // Build Master List of Expected People
        const allPeople = [];
        memSnap.forEach(d => allPeople.push({ id: d.id, ...d.data(), type: 'member' }));
        invSnap.forEach(d => allPeople.push({ id: d.id, ...d.data(), type: 'invitee' }));

        // Map Attendance
        const attendedIds = new Set();
        const attNotes = [];
        attSnap.forEach(doc => {
            const [mId] = doc.id.split('_');
            attendedIds.add(mId);
            if(doc.data().note) attNotes.push({ mId, ...doc.data() });
        });

        // Filter relevant people
        const relevantPeople = allPeople.filter(p => {
            const pastorMatch = pFilter === 'all' || p.pastorId === pFilter;
            const typeMatch = cFilter === 'all' || p.type === cFilter;
            return pastorMatch && typeMatch;
        });

        const presentPeople = relevantPeople.filter(p => attendedIds.has(p.id));
        const missingPeople = relevantPeople.filter(p => !attendedIds.has(p.id));

        // Render Missing Table
        missingTable.innerHTML = missingPeople.map(p => `
            <tr>
                <td><b>${p.full_name || (p.first_name + ' ' + p.last_name)}</b></td>
                <td><span style="opacity:0.6">${p.type.toUpperCase()}</span></td>
                <td>${p.invited_by || p.shepherd_name || 'System'}</td>
                <td><span class="badge-missing">Absent</span></td>
            </tr>
        `).join('') || '<tr><td colspan="4" style="text-align:center">All expected people are present.</td></tr>';

        // Render Graph
        renderGraph(presentPeople.length, relevantPeople.length);

        // Render Feed
        feed.innerHTML = attNotes.map(n => {
            const p = allPeople.find(x => x.id === n.mId);
            if(!p) return '';
            return `
                <div class="feed-card">
                    <div style="font-weight:600">${p.full_name || p.first_name}</div>
                    <div class="note-text">"${n.note}"</div>
                    <div style="font-size:0.7rem; opacity:0.5">${n.timestamp?.toDate().toLocaleDateString()}</div>
                </div>`;
        }).join('');
    }

    function renderGraph(present, total) {
        const percent = total > 0 ? (present / total) * 100 : 0;
        document.getElementById('graphArea').innerHTML = `
            <div class="bar-group">
                <div class="bar bar-absent" style="height: 100%"></div>
                <div class="bar-label">Expected (${total})</div>
            </div>
            <div class="bar-group">
                <div class="bar bar-present" style="height: ${percent}%"></div>
                <div class="bar-label">Present (${present})</div>
            </div>`;
    }

    [pastorFilter, timeFilter, typeFilter].forEach(el => el.onchange = updateView);
</script>
</body></html>
