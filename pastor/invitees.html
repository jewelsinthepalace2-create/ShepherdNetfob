<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Network Intelligence | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1); --green: #00ff88; --red: #ff4b5c; }
        body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; padding-bottom: 50px; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 1.4rem; }
        
        /* ANALYTICS GRAPH CARD */
        .analytics-card { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; }
        .graph-wrapper { display: flex; align-items: flex-end; gap: 50px; height: 160px; margin-top: 15px; }
        .bar-container { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .bar-track { width: 50px; height: 130px; background: rgba(255,255,255,0.05); border-radius: 25px; position: relative; overflow: hidden; }
        .bar-fill { width: 100%; position: absolute; bottom: 0; transition: height 1s ease; }
        .fill-target { background: linear-gradient(to top, #4facfe, #00f2fe); opacity: 0.4; }
        .fill-actual { background: linear-gradient(to top, #00ff88, #00b09b); }
        .stat-val { font-size: 1.1rem; font-weight: bold; }
        .stat-lbl { font-size: 0.65rem; opacity: 0.6; letter-spacing: 1px; }

        /* TABLE STYLES */
        .table-card { background: var(--glass); border: 1px solid var(--border); border-radius: 15px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; opacity: 0.5; padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.7rem; letter-spacing: 1px; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 0.85rem; vertical-align: middle; }
        
        /* BADGES */
        .badge { padding: 3px 8px; border-radius: 6px; font-size: 0.6rem; font-weight: 700; text-transform: uppercase; }
        .badge-member { background: rgba(79, 172, 254, 0.15); color: var(--primary); }
        .badge-invitee { background: rgba(255, 215, 0, 0.15); color: #ffd700; }
        
        /* STATUS & NOTES */
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .dot-green { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .dot-red { background: var(--red); box-shadow: 0 0 8px var(--red); }
        .note-text { font-size: 0.75rem; color: #ff4b5c; font-style: italic; display: block; margin-top: 4px; opacity: 0.9; }
        .effort-text { font-size: 0.7rem; font-family: monospace; color: #ccc; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Mission Report</h1>
            <p id="eventLabel" style="opacity:0.6; font-size: 0.8rem; margin-top:4px;">Connecting...</p>
        </div>
        <a href="index.html" style="color:var(--primary); text-decoration:none; border:1px solid var(--border); padding:6px 14px; border-radius:8px; font-size:0.8rem;">Exit</a>
    </header>

    <div class="analytics-card">
        <h3 style="margin:0; font-size:0.9rem; opacity:0.8; letter-spacing:1px;">ATTENDANCE YIELD</h3>
        <div class="graph-wrapper" id="graphArea">
            </div>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th width="30%">NAME / ROLE</th>
                    <th width="20%">EFFORT (Calls/Visits)</th>
                    <th width="15%">STATUS</th>
                    <th width="35%">CHALLENGES / NOTES</th>
                </tr>
            </thead>
            <tbody id="registryBody">
                <tr><td colspan="4" style="text-align:center; padding:30px; opacity:0.5;">Gathering Intelligence...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, serverTimestamp, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc", authDomain: "fob-database-139d1.firebaseapp.com", projectId: "fob-database-139d1", storageBucket: "fob-database-139d1.firebasestorage.app", appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app, "fobrealdbase");
    const auth = getAuth(app);
    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
        if(user) { currentUser = user; loadInvitees(); }
        else location.href = "index.html";
    });

    // --- 1. ADD NEW INVITEE (Permanent List) ---
    window.addInvitee = async () => {
        const name = document.getElementById('invName').value;
        const phone = document.getElementById('invPhone').value;
        const hostel = document.getElementById('invHostel').value;
        if(!name) return alert("Name is required");

        await addDoc(collection(db, "invitees"), {
            fullName: name, phone, hostel,
            shepherdId: currentUser.uid,
            // These are the "Current Week" stats
            calls: 0, visits: 0, status: 'unmarked', notes: "",
            lastUpdated: serverTimestamp(),
            // This array will hold all previous weeks' data
            history: [] 
        });
        location.reload();
    };

    // --- 2. LOAD LIST (With Visual Reset) ---
    async function loadInvitees() {
        const q = query(collection(db, "invitees"), where("shepherdId", "==", currentUser.uid));
        const snap = await getDocs(q);
        let html = "";
        
        // Define the "Freshness" Window (e.g., Since Last Monday)
        const lastMonday = new Date();
        lastMonday.setDate(lastMonday.getDate() - (lastMonday.getDay() + 6) % 7);
        lastMonday.setHours(0,0,0,0);

        snap.forEach(d => {
            const data = d.data();
            const id = d.id;
            if(data.status === 'graduated') return;

            // CHECK: Is the data from this current service cycle?
            const lastUpdate = data.lastUpdated ? data.lastUpdated.toDate() : new Date(0);
            const isFresh = lastUpdate > lastMonday;

            // VISUAL RESET: If data is old, show 0 on screen (even if DB still has old numbers)
            // We only "Commit" the reset to DB when the user clicks a button.
            const displayCalls = isFresh ? (data.calls || 0) : 0;
            const displayVisits = isFresh ? (data.visits || 0) : 0;
            const displayStatus = isFresh ? (data.status || 'unmarked') : 'unmarked';

            // Button Styles based on status
            const presentStyle = displayStatus === 'honoured' ? 'background:var(--green); color:black;' : '';
            const absentStyle = displayStatus === 'declined' ? 'background:var(--red); color:white;' : '';

            html += `
            <div class="invitee-item">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <div>
                        <span style="font-size:1.1rem; font-weight:600;">${data.fullName}</span><br>
                        <small style="opacity:0.6;">${data.hostel || 'No Address'}</small>
                    </div>
                    <a href="tel:${data.phone}" style="text-decoration:none; background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:8px; height:fit-content;">ðŸ“ž</a>
                </div>
                
                <div class="effort-grid">
                    <div class="effort-box">
                        <span class="effort-label">CALLS</span>
                        <div class="counter-controls">
                            <button class="btn-count" onclick="modifyEffort('${id}', 'calls', -1, ${isFresh})">-</button>
                            <span class="count-val">${displayCalls}</span>
                            <button class="btn-count" onclick="modifyEffort('${id}', 'calls', 1, ${isFresh})">+</button>
                        </div>
                    </div>
                    <div class="effort-box">
                        <span class="effort-label">VISITS</span>
                        <div class="counter-controls">
                            <button class="btn-count" onclick="modifyEffort('${id}', 'visits', -1, ${isFresh})">-</button>
                            <span class="count-val">${displayVisits}</span>
                            <button class="btn-count" onclick="modifyEffort('${id}', 'visits', 1, ${isFresh})">+</button>
                        </div>
                    </div>
                </div>

                <div class="action-row" id="btns-${id}">
                    <button class="btn-action btn-absent" style="${absentStyle}" onclick="toggleReason('${id}', true)">Did Not Come</button>
                    <button class="btn-action btn-present" style="${presentStyle}" onclick="setStatus('${id}', 'honoured', ${isFresh})">Honoured</button>
                </div>

                <div id="reason-box-${id}" class="reason-box">
                    <input type="text" id="reason-${id}" class="reason-input" placeholder="Why? (e.g. Sick, Traveled)">
                    <button class="btn-action btn-absent" onclick="saveAbsence('${id}', ${isFresh})">Save Reason</button>
                </div>
            </div>`;
        });
        document.getElementById('listArea').innerHTML = html || "<p style='text-align:center; opacity:0.5; padding:30px;'>No invitees yet.</p>";
    }

    // --- 3. THE "ARCHIVE & RESET" LOGIC ---
    // This function runs BEFORE any update if the data is "stale" (old)
    async function handleFreshness(docRef, isFresh) {
        if (isFresh) return; // If data is fresh, do nothing.

        // If data is OLD, we must archive it before overwriting.
        const snap = await getDoc(docRef);
        const oldData = snap.data();

        // 1. Archive old data to history array
        const historyEntry = {
            period: oldData.lastUpdated || new Date(),
            calls: oldData.calls || 0,
            visits: oldData.visits || 0,
            status: oldData.status || 'unmarked',
            notes: oldData.notes || ""
        };

        // 2. Reset main fields to 0
        await updateDoc(docRef, {
            history: arrayUnion(historyEntry), // Save history
            calls: 0,
            visits: 0,
            status: 'unmarked',
            notes: "",
            lastUpdated: serverTimestamp() // Mark as fresh for today
        });
    }

    // --- 4. BUTTON HANDLERS ---
    
    window.modifyEffort = async (id, field, change, isFresh) => {
        const docRef = doc(db, "invitees", id);
        
        // Step 1: Ensure we are working on a FRESH record
        if (!isFresh) await handleFreshness(docRef, false);

        // Step 2: Now it's safe to increment/decrement
        const snap = await getDoc(docRef);
        let newVal = (snap.data()[field] || 0) + change;
        if (newVal < 0) newVal = 0;

        await updateDoc(docRef, { 
            [field]: newVal, 
            lastUpdated: serverTimestamp() 
        });
        loadInvitees(); // Refresh UI
    };

    window.setStatus = async (id, status, isFresh) => {
        const docRef = doc(db, "invitees", id);
        if (!isFresh) await handleFreshness(docRef, false);

        await updateDoc(docRef, { 
            status: status, 
            lastUpdated: serverTimestamp() 
        });
        loadInvitees();
    };

    window.saveAbsence = async (id, isFresh) => {
        const docRef = doc(db, "invitees", id);
        if (!isFresh) await handleFreshness(docRef, false);

        const reason = document.getElementById(`reason-${id}`).value;
        await updateDoc(docRef, { 
            status: 'declined', 
            notes: reason,
            lastUpdated: serverTimestamp() 
        });
        loadInvitees();
    };

    window.toggleReason = (id, show) => {
        document.getElementById(`btns-${id}`).style.display = show ? 'none' : 'flex';
        document.getElementById(`reason-box-${id}`).style.display = show ? 'block' : 'none';
    };
</script>
</body>
</html>
